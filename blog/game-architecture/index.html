<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Enjoyable Game Architecture | Chickensoft ‚Äî Open source tools for Godot and C#</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chickensoft.games/blog/game-architecture"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Enjoyable Game Architecture | Chickensoft ‚Äî Open source tools for Godot and C#"><meta data-rh="true" name="description" content="If we can make building games easier, we can focus on the hard part: designing them.
"><meta data-rh="true" property="og:description" content="If we can make building games easier, we can focus on the hard part: designing them.
"><meta data-rh="true" name="keywords" content="software architecture,architecture,Godot,C#,game design,game engine,Unity,indie game development,open source,foss,programming language,game development,scripting,performance optimization,syntax comparison,cross-platform,community support,tutorials,game engine features,2D game development,3D game development,game development tips,game programming,game publishing"><meta data-rh="true" property="og:image" content="https://chickensoft.games/assets/images/header-ea6f7d4f5f558f0c32f8a911c6e971bc.jpg"><meta data-rh="true" name="twitter:image" content="https://chickensoft.games/assets/images/header-ea6f7d4f5f558f0c32f8a911c6e971bc.jpg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-12-01T00:00:00.000Z"><meta data-rh="true" property="article:author" content="/authors/joanna"><link data-rh="true" rel="icon" href="/img/chickensoft/favicon.png"><link data-rh="true" rel="canonical" href="https://chickensoft.games/blog/game-architecture"><link data-rh="true" rel="alternate" href="https://chickensoft.games/blog/game-architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://chickensoft.games/blog/game-architecture" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9WXTBSQCGL"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-9WXTBSQCGL",{anonymize_ip:!0})</script>


<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Chickensoft ‚Äî Open source tools for Godot and C# RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Chickensoft ‚Äî Open source tools for Godot and C# Atom Feed">

<link rel="me" href="https://mastodon.online/@jolexxa"><link rel="stylesheet" href="/assets/css/styles.ff48705b.css">
<link rel="preload" href="/assets/js/runtime~main.b9624ef8.js" as="script">
<link rel="preload" href="/assets/js/main.b297899a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/chickensoft/chickensoft_logo.svg" alt="Chickensoft Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/chickensoft/chickensoft_logo.svg" alt="Chickensoft Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Chickensoft</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://forms.gle/CZLsupjR3GM4a85v9" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">üê§ Using our projects?</a><a href="https://github.com/chickensoft-games" class="ghNavIconContainer_HpC9"><svg class="ghNavIcon_tQt8" width="24" height="24" viewBox="0 0 19 19" version="1.1" id="svg3" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" id="path2" d="m 9.46,0.502 c -4.93,0 -8.928,3.997 -8.928,8.929 0,3.944 2.558,7.291 6.106,8.472 0.447,0.081 0.609,-0.194 0.609,-0.431 C 7.247,17.26 7.24,16.699 7.235,15.954 4.752,16.493 4.228,14.757 4.228,14.757 3.822,13.725 3.236,13.451 3.236,13.451 c -0.81,-0.554 0.062,-0.543 0.062,-0.543 0.896,0.063 1.367,0.92 1.367,0.92 0.797,1.365 2.09,0.971 2.599,0.742 C 7.345,13.993 7.576,13.599 7.831,13.376 5.848,13.151 3.764,12.385 3.764,8.964 3.764,7.989 4.112,7.192 4.683,6.568 4.591,6.342 4.284,5.434 4.77,4.205 c 0,0 0.75,-0.24 2.455,0.915 0.712,-0.198 1.477,-0.297 2.236,-0.3 0.758,0.003 1.522,0.102 2.235,0.3 1.704,-1.155 2.453,-0.915 2.453,-0.915 0.487,1.229 0.181,2.137 0.089,2.363 0.572,0.624 0.918,1.421 0.918,2.396 0,3.43 -2.088,4.184 -4.077,4.405 0.32,0.276 0.606,0.821 0.606,1.654 0,1.194 -0.011,2.157 -0.011,2.449 0,0.239 0.161,0.517 0.614,0.43 3.545,-1.183 6.101,-4.528 6.101,-8.471 0,-4.932 -3.998,-8.929 -8.929,-8.929 z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All Posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/serialization-for-csharp-games">Serialization for C# Games</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/godot-csharp-2024">Using Godot with C# in 2024</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/game-architecture">Enjoyable Game Architecture</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/godot-delivers">Can Godot Deliver?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/gdscript-vs-csharp">GDScript vs C# in Godot 4</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/godot-unity-alternative">Godot and C#: A Viable Unity Alternative</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/indie-game-godot">It‚Äôs time to make that indie C# game in Godot.</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="If we can make building games easier, we can focus on the hard part: designing them.
"><link itemprop="image" href="https://chickensoft.games/assets/images/header-ea6f7d4f5f558f0c32f8a911c6e971bc.jpg"><meta itemprop="keywords" content="software architecture,architecture,Godot,C#,game design,game engine,Unity,indie game development,open source,foss,programming language,game development,scripting,performance optimization,syntax comparison,cross-platform,community support,tutorials,game engine features,2D game development,3D game development,game development tips,game programming,game publishing"><header><h1 class="title_f1Hy" itemprop="headline">Enjoyable Game Architecture</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-12-01T00:00:00.000Z" itemprop="datePublished">December 1, 2023</time> ¬∑ <!-- -->38 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/authors/joanna"><img class="avatar__photo" src="/img/authors/joanna.jpg" alt="Joanna" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url" href="/authors/joanna"><span itemprop="name">Joanna</span></a></div><small class="avatar__subtitle" itemprop="description">Chickensoft Organizer</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/header-ea6f7d4f5f558f0c32f8a911c6e971bc.jpg"><img src="/assets/images/header-ea6f7d4f5f558f0c32f8a911c6e971bc.jpg" alt="Game architecture header image." style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center"></figcaption></figure><p>Game architecture, like all software architecture, tends to be neglected or forgotten as a project goes on. Scalable, enjoyable, production codebases are so rare they&#x27;re almost mythical.</p><p>It doesn&#x27;t have to be this way: just because video game development is difficult doesn&#x27;t mean it has to be painful. You can still achieve a robust software architecture that scales with your game ‚Äî¬†even as you rework core systems and make sweeping refactors. Since architecture is based on expert opinions and developer experiences, we&#x27;ll borrow from the wisdom of other software architectures to create a game architecture that prioritizes an enjoyable developer experience.</p><p>Over the last few years, I&#x27;ve been making and maintaining over a dozen open source packages for Godot and C#. While leveraging these packages and the opinionated architecture described in this article, I was able to build a 3D platformer demo in just a month or two of spare time. If you&#x27;re willing to stick around, I&#x27;d love to share the methodology, the rationale, and even the demo itself with you.</p><section style="margin-bottom:var(--ifm-leading)"><div class="youtubeOuterContainer_mhb6"><div class="youtubeContainer_nPLO"><iframe src="https://www.youtube.com/embed/LEethjxNnrw?si=LPGQLn3C2x9hgmPm" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" class="youtubeIFrame_MaaU"></iframe></div></div></section><p>In the demo, your goal is to collect all the coins hidden in the 3D world. Go ahead and take a quick look at the demo&#x27;s code on GitHub: if you like the way the code is written, you&#x27;ll like this article. If you don&#x27;t, you should write a rebuttal. Either way, I look forward to hearing from you.</p><section style="margin-bottom:var(--ifm-leading)"><a href="https://github.com/chickensoft-games/GameDemo" class="ghCard_SADR"><header class="header_EL4w"><div class="ghLogo_Dvj7"><svg width="24" height="24" viewBox="0 0 19 19" version="1.1" id="svg3" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" id="path2" d="m 9.46,0.502 c -4.93,0 -8.928,3.997 -8.928,8.929 0,3.944 2.558,7.291 6.106,8.472 0.447,0.081 0.609,-0.194 0.609,-0.431 C 7.247,17.26 7.24,16.699 7.235,15.954 4.752,16.493 4.228,14.757 4.228,14.757 3.822,13.725 3.236,13.451 3.236,13.451 c -0.81,-0.554 0.062,-0.543 0.062,-0.543 0.896,0.063 1.367,0.92 1.367,0.92 0.797,1.365 2.09,0.971 2.599,0.742 C 7.345,13.993 7.576,13.599 7.831,13.376 5.848,13.151 3.764,12.385 3.764,8.964 3.764,7.989 4.112,7.192 4.683,6.568 4.591,6.342 4.284,5.434 4.77,4.205 c 0,0 0.75,-0.24 2.455,0.915 0.712,-0.198 1.477,-0.297 2.236,-0.3 0.758,0.003 1.522,0.102 2.235,0.3 1.704,-1.155 2.453,-0.915 2.453,-0.915 0.487,1.229 0.181,2.137 0.089,2.363 0.572,0.624 0.918,1.421 0.918,2.396 0,3.43 -2.088,4.184 -4.077,4.405 0.32,0.276 0.606,0.821 0.606,1.654 0,1.194 -0.011,2.157 -0.011,2.449 0,0.239 0.161,0.517 0.614,0.43 3.545,-1.183 6.101,-4.528 6.101,-8.471 0,-4.932 -3.998,-8.929 -8.929,-8.929 z"></path></svg></div><div class="headerTitle__RVn"><h2>chickensoft-games<!-- -->/</h2><h1>GameDemo</h1></div><div class="headerLogo_j3df"><img src="/img/chickensoft/game_demo.png" width="auto" height="auto"></div></header><summary class="description_nH2g">The Chickensoft Game Demo ‚Äî a fully tested, third-person 3D game built with Godot and C#. Now with saving and loading!</summary><footer class="footer_DLm1"><div class="footerItem_ahyA"><svg width="21" height="24" role="img" version="1.1" viewBox="0 0 14 16"><path fill="currentColor" fill-rule="evenodd" d="M14 6l-4.9-.64L7 1 4.9 5.36 0 6l3.6 3.26L2.67 14 7 11.67 11.33 14l-.93-4.74z"></path></svg><div class="symbolAndLabel_ZGFn"><span class="symbol_q0_X">356</span><span class="label_phh9">Stars</span></div></div><div class="footerItem_ahyA"><svg width="15" height="24" role="img" version="1.1" viewBox="0 0 10 16"><path fill="currentColor" fill-rule="evenodd" d="M8 1a1.993 1.993 0 0 0-1 3.72V6L5 8 3 6V4.72A1.993 1.993 0 0 0 2 1a1.993 1.993 0 0 0-1 3.72V6.5l3 3v1.78A1.993 1.993 0 0 0 5 15a1.993 1.993 0 0 0 1-3.72V9.5l3-3V4.72A1.993 1.993 0 0 0 8 1zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zm3 10c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zm3-10c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg><div class="symbolAndLabel_ZGFn"><span class="symbol_q0_X">27</span><span class="label_phh9">Forks</span></div></div><div class="footerItemLanguages_BkNk"><span class="langColor_kTSd" style="background-color:#178600"></span><div class="symbolAndLabel_ZGFn"><span class="symbol_q0_X">C#</span></div></div></footer></a></section><blockquote><p>Most of the assets used in the demo are free assets created by <a href="https://www.gdquest.com/" target="_blank" rel="noopener noreferrer">GDQuest</a> ‚Äî please check them out and support their efforts!</p></blockquote><p>Why am I tackling something as subjective and nebulous as architecture? Because, deep down inside, I believe most of us don&#x27;t want to bother with architecture. We just want to make our game and have a good time doing it. Unfortunately, if you just start writing code without a second thought, you&#x27;ll often find that the further you get, the harder it gets.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/white_whale-5a772e414e51ef8cad4267dbb811e8d0.png"><img src="/assets/images/white_whale-5a772e414e51ef8cad4267dbb811e8d0.png" alt="Architecture: software engineering&#x27;s white whale." style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">A spoof of the charts in Martin Fowler&#x27;s article <a href="https://martinfowler.com/articles/is-quality-worth-cost.html" target="_blank" rel="noopener noreferrer">&quot;Is High Quality Software Worth the Cost?&quot;</a>.</figcaption></figure><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-what-is-software-architecture">üí° What Is Software Architecture?<a href="#-what-is-software-architecture" class="hash-link" aria-label="Direct link to üí° What Is Software Architecture?" title="Direct link to üí° What Is Software Architecture?">‚Äã</a></h2><p>You already know, but we&#x27;ll define it anyways for the sake of completeness.</p><p><em>A software architecture is a set of rules and practices designed around the developers&#x27; goals for their team&#x27;s code.</em></p><p>Whether or not those practices actually accomplish those goals is another matter entirely.</p><p>I believe a good architecture is <strong>opinionated</strong>, <strong>based on learnings from past projects</strong> which met the same (or similar) goals, and <strong>plays nicely with the development tools</strong> for your particular stack: i.e., <em>a good architecture should provide structure, be based on experience, and be practical to implement</em>.</p><p>If there&#x27;s two equally good ways to do something, a good architecture will pick one as the recommended approach. Good architectures embrace collectivism, not individualism. Each feature or component should be implemented similarly to the other features and components. Increasing code-similarity allows developers to ramp up quickly, switch between features with relative ease, and reduces the number of complex details they have to remember.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/architecture_sanity-b15bf35a04b9a6bcad219cad75611dc8.png"><img src="/assets/images/architecture_sanity-b15bf35a04b9a6bcad219cad75611dc8.png" alt="Architecture sanity test." style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">When loose coupling is eliminated, a good architecture should probably be a directed, acyclic graph.</figcaption></figure><p>Below, I&#x27;ve listed some common, high-level goals that a good architecture might be designed around. These goals range from overall organizational practices to annoying details about where files should be placed and how code should be formatted and linted.</p><ol><li><strong>Organization</strong>: Where do I put code and related assets when adding a new feature?</li><li><strong>Development</strong>: How do I know what code to write to accomplish a feature?</li><li><strong>Testing</strong>: How do I write tests for my feature?</li><li><strong>Structure</strong>: How do I get the dependencies my features need?</li><li><strong>Consistency</strong>: How do I keep my code formatted? (Yes, this is important. If you don&#x27;t have automatic style enforcement, you can run into problems where your IDE&#x27;s language server is trying to apply auto-fixes that make your life hard with the style of coding you&#x27;ve chosen.)</li><li><strong>Flexibility</strong>: What happens when I need to refactor something? An optimal architecture would allow us to overhaul a feature without breaking the other features, enabling us to iterate faster and keep our code flexible.</li></ol><p>While the architecture can&#x27;t hold your hand and give you line-by-line coding instructions (that&#x27;s the job of the senior developers on your team), it should, at least, give you a good idea of where to start when you first grab that ticket off the backlog.</p><p>A good architecture should help prevent writer&#x27;s, er, coder&#x27;s block when you first start on a new feature. It should take the guesswork out of what should be mundane procedures (like scaffolding out a new view, its state management, and its tests) and turn it into something you can do in your sleep (or automate with some snippets).</p><p>To achieve the lofty goals above, we&#x27;ll create specific, concrete requirements for our architecture that serves our noble goals. Our ideal architecture should‚Ä¶</p><ol><li>Define <strong>abstraction layers</strong> to organize code modules.</li><li>Provide an <strong>organization system</strong> for the files and assets in the codebase.</li><li>Allow each &quot;unit&quot; of code to be <strong>tested in isolation</strong>.</li></ol><p>To meet these goals, we&#x27;ll draw inspiration from a number of existing patterns and architectures, casually incorporating whatever we like.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-abstraction-layers">üç∞ Abstraction Layers<a href="#-abstraction-layers" class="hash-link" aria-label="Direct link to üç∞ Abstraction Layers" title="Direct link to üç∞ Abstraction Layers">‚Äã</a></h2><p>Our ideal architecture should provide an opinion about the overall structure of our game. In a typical visual application, you might have the view layer, business logic / domain layer, and the data layer.</p><p>For games, we can make our own, similar layers. Each layer will correspond to a type of object in our codebase.</p><ul><li><strong>Visual Layer</strong> ‚Äî Scripted game engine components. A Unity <code>MonoBehavior</code> attached to a game object, a Godot <code>Node</code> script class, etc.</li><li><strong>GameLogic Layer</strong> ‚Äî the meat and potatoes of your game, itself broken into two &quot;sublayers&quot;:<ul><li><strong>Visual Game Logic Layer</strong> ‚Äî state machines, behavior trees, or other stateful mechanisms that drive a single game engine component&#x27;s state.</li><li><strong>Pure Game Logic Layer</strong> ‚Äî repository classes that perform game logic that&#x27;s not specific to any single visual component.</li></ul></li><li><strong>Data Layer</strong> ‚Äî Various client classes for &quot;lower level&quot; interactions, such as networking and persistent storage.</li></ul><p>Together, these 3 abstraction layers allow us to look at our game critically. Most pieces of code should fall into one of those layers nicely.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/game_architecture-867fa678f6d73270240dfe3c2729d661.png"><img src="/assets/images/game_architecture-867fa678f6d73270240dfe3c2729d661.png" alt="Game Architecture Layers of Abstraction" style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">The big 3 abstraction layers: visuals, game logic, and data.</figcaption></figure><blockquote><p>Differentiating game logic into visual game logic and pure game logic is an idea reminiscent of the way <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html" target="_blank" rel="noopener noreferrer">clean architecture</a> distinguishes between &quot;enterprise-wide business rules&quot; and &quot;application specific business rules.&quot;</p></blockquote><p>We&#x27;ll also introduce an additional stipulation into our architecture: objects in one layer can only be strongly coupled with objects in the layer directly below them. You might recognize this rule from the strict form of <a href="https://cs.uwaterloo.ca/~m2nagapp/courses/CS446/1195/Arch_Design_Activity/Layered.pdf" target="_blank" rel="noopener noreferrer">layered architecture</a>.</p><p>Restricting objects to only interacting with objects in the layer directly beneath them prevents sibling dependencies in the same layer (strong coupling), as well as &quot;skipping&quot; layers, which would indicate a design oversight.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-visual-layer">üé≠ Visual Layer<a href="#-visual-layer" class="hash-link" aria-label="Direct link to üé≠ Visual Layer" title="Direct link to üé≠ Visual Layer">‚Äã</a></h3><p>Visual components drive the things we see in the game engine. They come in many flavors, but tend to be pretty similar across game engines. In Unity, you&#x27;ll find <code>MonoBehavior</code> components that are applied to GameObjects. In Godot, we subclass a Godot <code>Node</code> and attach the script to a scene node. Both of these systems allow us to represent visual components within the engine.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/visual_component-455386920e6cd1664d664d4e801c1cc9.png"><img src="/assets/images/visual_component-455386920e6cd1664d664d4e801c1cc9.png" alt="Game Engine Visual Components" style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">You know, the part you can actually see.</figcaption></figure><p>Most game developers will reiterate the importance of separating your visual logic from your game logic, citing the <a href="https://en.wikipedia.org/wiki/Single-responsibility_principle" target="_blank" rel="noopener noreferrer">single responsibility principle</a> ‚Äî so, how do you do that exactly?</p><p>Mechanisms like <strong>state machines</strong> and <strong>behavior trees</strong> are commonly used to separate the &quot;state&quot; of something from the code that visualizes it. For example, a visual script can create a state machine and provide a reference to itself to the state machine, allowing the state machine to &quot;drive&quot; the visual object as it changes between states. The visual script can likewise hang onto a reference to its state machine, forwarding relevant input events to it, giving the state machine a chance to drive it whenever something happens.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/game_engine-974d2810a76193ccddf93020fdc2bdd5.png"><img src="/assets/images/game_engine-974d2810a76193ccddf93020fdc2bdd5.png" alt="Level being edited in the Godot game engine." style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">Editing a level in the Godot game engine.</figcaption></figure><p>An optimal architecture would probably eliminate conditional branching from visual game component scripts altogether, performing all logic in the component&#x27;s state machine or other state mechanism.</p><p>Real life isn&#x27;t always so pretty, though: for performance reasons, it&#x27;s often advantageous to have a few checks in the visual component itself to decide if it&#x27;s even worth passing an event to the state machine. If you don&#x27;t, garbage collected languages like C# can generate a lot of unnecessary memory pressure, depending on how carefully you handle input queuing and memory allocation.</p><p>Below is a minimum example of a visual node script. For the sake of example, it is completely stateless. The only event that can happen ‚Äî the main menu button being pressed ‚Äî is forwarded via the use of a signal, allowing a stateful ancestor to manipulate this node.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">[</span><span class="token attribute class-name">Meta</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments keyword" style="color:#ffcc99">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments type-expression class-name">IAutoNode</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">partial</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">class</span><span class="token plain"> </span><span class="token class-name">WinMenu</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token type-list class-name">Control</span><span class="token type-list punctuation" style="color:#6c6783">,</span><span class="token type-list"> </span><span class="token type-list class-name">IWinMenu</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">override</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">_Notification</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name keyword" style="color:#ffcc99">int</span><span class="token plain"> what</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">this</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Notify</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">what</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">region</span><span class="token preprocessor property" style="color:#9a86fd"> Nodes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain">Node</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name">IButton</span><span class="token plain"> MainMenuButton </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">get</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">set</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">default</span><span class="token operator" style="color:#e09142">!</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">endregion</span><span class="token preprocessor property" style="color:#9a86fd"> Nodes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">region</span><span class="token preprocessor property" style="color:#9a86fd"> Signals</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain">Signal</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">delegate</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">MainMenuEventHandler</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">endregion</span><span class="token preprocessor property" style="color:#9a86fd"> Signals</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnReady</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> MainMenuButton</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Pressed </span><span class="token operator" style="color:#e09142">+=</span><span class="token plain"> OnMainMenuPressed</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnExitTree</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> MainMenuButton</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Pressed </span><span class="token operator" style="color:#e09142">-=</span><span class="token plain"> OnMainMenuPressed</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnMainMenuPressed</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">EmitSignal</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">SignalName</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">MainMenu</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>You&#x27;ll often find that many nodes can be stateless, simply signaling when something happens. Stripping as much logic out of the visual layer is beneficial because it allows stateful, parent nodes to manipulate the simpler, stateless nodes. For comparison, Google&#x27;s cross platform app framework <a href="https://flutter.dev/" target="_blank" rel="noopener noreferrer">Flutter</a> specifically forces you to distinguish between a <a href="https://api.flutter.dev/flutter/widgets/StatefulWidget-class.html" target="_blank" rel="noopener noreferrer">StatefulWidget</a> and a <a href="https://api.flutter.dev/flutter/widgets/StatelessWidget-class.html" target="_blank" rel="noopener noreferrer">StatelessWidget</a>. This same distinction applies to Godot, since they both share a visual, tree-based composition structure.</p></blockquote><p>We&#x27;ll be making extensive use of the <a href="https://github.com/chickensoft-games/Introspection" target="_blank" rel="noopener noreferrer">Introspection</a> source generator, which lets us inject code into our node classes via <a href="https://en.wikipedia.org/wiki/Mixin" target="_blank" rel="noopener noreferrer">mixins</a>.</p><p>In the example above, the <code>IAutoNode</code> mixin enables the <code>WinMenu</code> class to connect the <code>MainMenuButton</code> property to its corresponding node with the same unique identifier, <code>%MainMenuButton</code> in the scene. Little tricks like that help save us a ton of error-prone typing.</p><p>The <code>IAutoNode</code> mixin comes from <a href="https://github.com/chickensoft-games/AutoInject" target="_blank" rel="noopener noreferrer">AutoInject</a>, which provides a number of utilities in addition to dependency injection.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-gamelogic-layer">ü§ñ GameLogic Layer<a href="#-gamelogic-layer" class="hash-link" aria-label="Direct link to ü§ñ GameLogic Layer" title="Direct link to ü§ñ GameLogic Layer">‚Äã</a></h3><p>Game logic simply refers to code that manipulates the game and its mechanics, without having to directly worry about other concerns like how the game is visualized, networked, or persisted.</p><p>In our architecture, we differentiate between two kinds of game logic. Let&#x27;s look at each one.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-visual-game-logic-layer">üñº Visual Game Logic Layer<a href="#-visual-game-logic-layer" class="hash-link" aria-label="Direct link to üñº Visual Game Logic Layer" title="Direct link to üñº Visual Game Logic Layer">‚Äã</a></h4><p>As mentioned, visual game logic is just code that&#x27;s specific to a single visual component (state machines, behavior trees, or other stateful mechanisms that belong to a specific visual component).</p><p>For visuals that do anything more than just appearing in game, they should probably have a reference to a <a href="https://en.wikipedia.org/wiki/Behavior_tree_(artificial_intelligence,_robotics_and_control)" target="_blank" rel="noopener noreferrer">behavior tree</a>, <a href="https://en.wikipedia.org/wiki/Finite-state_machine" target="_blank" rel="noopener noreferrer">state machine</a>, <a href="https://statecharts.dev/" target="_blank" rel="noopener noreferrer">statechart</a>, or other such stateful mechanism that represents their state-of-being.</p><p>Stateful mechanisms can be loosely coupled to their owning components via an interface, enabling them to &quot;drive&quot; their visual components by calling methods on them or producing outputs that the visual game component binds to.</p><p><em>The visual component&#x27;s job is to shut up and look pretty</em>. The dumber it is, the better. An ideal visual component will just forward all inputs to its underlying state machine (or whatever it&#x27;s using).</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/visual_game_logic-58ace245755dd76920efc883b3017c33.png"><img src="/assets/images/visual_game_logic-58ace245755dd76920efc883b3017c33.png" alt="Game Engine Visual Components" style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">You know, the part you can actually see.</figcaption></figure><h5 class="anchor anchorWithStickyNavbar_LWe7" id="state-management-in-practice">State Management In Practice<a href="#state-management-in-practice" class="hash-link" aria-label="Direct link to State Management In Practice" title="Direct link to State Management In Practice">‚Äã</a></h5><p>For some of the more complex visual components in your game, a simple state machine would get out of hand quickly. Most likely, you&#x27;ll end up using a <a href="https://statecharts.dev/" target="_blank" rel="noopener noreferrer">statechart</a>, a type of hierarchical state machine that can help avoid the pitfalls of ordinary state machines.</p><p>Fortunately, I&#x27;ve already created an ergonomic, hierarchical state machine implementation called <a href="https://github.com/chickensoft-games/LogicBlocks" target="_blank" rel="noopener noreferrer">LogicBlocks</a> that allows you to write your states the way you write ordinary C# <del>classes</del> records. In the game demo, LogicBlocks easily handled the menu transition logic, overall pause mode, player state machine, and every other stateful component.</p><p>I&#x27;d recommend at least considering using LogicBlocks, for the following reasons:</p><ul><li>Includes a picture generator that reads your code and helps you visualize it as a UML state diagram.</li><li>Easily testable (abstracts inputs and outputs).</li><li>No need to define transition tables. It operates more like a <a href="https://en.wikipedia.org/wiki/Moore_machine" target="_blank" rel="noopener noreferrer">Moore machine</a>, which is a lot more ergonomic than the typical transition-based approach.</li><li>Correctly implements state entrance and exit callbacks for nested states.</li><li>Correctly queues and processes inputs.</li><li>Provides states with a blackboard ‚Äî a shared data store.</li><li>Includes an ergonomic binding system that allows you to easily synchronize the visual component with its state.</li><li>LogicBlocks can add input to themselves, allowing them to initiate subsequent state changes.</li></ul><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/player-07a393d7baeac69a0a584374cbb3cf32.png"><img src="/assets/images/player-07a393d7baeac69a0a584374cbb3cf32.png" alt="Player state diagram generated by LogicBlocks." style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">State diagram generated by LogicBlocks for the player in the 3D platformer demo.</figcaption></figure><p>Below, here&#x27;s the <code>InGameUILogic</code> state machine from the game demo. It&#x27;s an incredibly simple state machine ‚Äî it only has one state that subscribes to the <code>AppRepository</code> (see next section for details) and produces outputs whenever the number of coins changes.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">partial</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">class</span><span class="token plain"> </span><span class="token class-name">InGameUILogic</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">record</span><span class="token plain"> </span><span class="token class-name">State</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token type-list class-name">StateLogic</span><span class="token type-list punctuation" style="color:#6c6783">,</span><span class="token type-list"> </span><span class="token type-list class-name">IState</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">State</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name">IContext</span><span class="token plain"> context</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">base</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token class-name keyword" style="color:#ffcc99">var</span><span class="token plain"> appRepo </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token generic-method function" style="color:#9a86fd">Get</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">IAppRepo</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token generic-method function" style="color:#9a86fd">OnEnter</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">State</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">previous</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        appRepo</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsCollected</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Sync </span><span class="token operator" style="color:#e09142">+=</span><span class="token plain"> OnNumCoinsCollected</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        appRepo</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsAtStart</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Sync </span><span class="token operator" style="color:#e09142">+=</span><span class="token plain"> OnNumCoinsAtStart</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token generic-method function" style="color:#9a86fd">OnExit</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">State</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">next</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        appRepo</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsCollected</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Sync </span><span class="token operator" style="color:#e09142">-=</span><span class="token plain"> OnNumCoinsCollected</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        appRepo</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsAtStart</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Sync </span><span class="token operator" style="color:#e09142">-=</span><span class="token plain"> OnNumCoinsAtStart</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnNumCoinsCollected</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name keyword" style="color:#ffcc99">int</span><span class="token plain"> numCoinsCollected</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      Context</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Output</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Output</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">.</span><span class="token constructor-invocation class-name">NumCoinsChanged</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">numCoinsCollected</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token generic-method function" style="color:#9a86fd">Get</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">IAppRepo</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsAtStart</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnNumCoinsAtStart</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name keyword" style="color:#ffcc99">int</span><span class="token plain"> numCoinsAtStart</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      Context</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Output</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Output</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">.</span><span class="token constructor-invocation class-name">NumCoinsChanged</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token generic-method function" style="color:#9a86fd">Get</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">IAppRepo</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsCollected</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> numCoinsAtStart</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Meanwhile, the actual Godot node for the <code>InGameUI</code> binds to the state machine&#x27;s outputs, updating the UI whenever the number of coins changes.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">[</span><span class="token attribute class-name">Meta</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments keyword" style="color:#ffcc99">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments type-expression class-name">IAutoNode</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">partial</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">class</span><span class="token plain"> </span><span class="token class-name">InGameUI</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token type-list class-name">Control</span><span class="token type-list punctuation" style="color:#6c6783">,</span><span class="token type-list"> </span><span class="token type-list class-name">IInGameUI</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token comment" style="color:#6c6783">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnResolved</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    InGameUIBinding </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> InGameUILogic</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Bind</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    InGameUIBinding</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">.</span><span class="token generic-method function" style="color:#9a86fd">Handle</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">InGameUILogic</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Output</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">NumCoinsChanged</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">SetCoinsLabel</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">          output</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsCollected</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsAtStart</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    InGameUILogic</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Start</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">SetCoinsLabel</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name keyword" style="color:#ffcc99">int</span><span class="token plain"> coins</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#ffcc99">int</span><span class="token plain"> totalCoins</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    CoinsLabel</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Text </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:#ffcc99">$&quot;</span><span class="token interpolation-string interpolation punctuation" style="color:#6c6783">{</span><span class="token interpolation-string interpolation expression language-csharp">coins</span><span class="token interpolation-string interpolation punctuation" style="color:#6c6783">}</span><span class="token interpolation-string string" style="color:#ffcc99">/</span><span class="token interpolation-string interpolation punctuation" style="color:#6c6783">{</span><span class="token interpolation-string interpolation expression language-csharp">totalCoins</span><span class="token interpolation-string interpolation punctuation" style="color:#6c6783">}</span><span class="token interpolation-string string" style="color:#ffcc99">&quot;</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token comment" style="color:#6c6783">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-pure-game-logic-layer">üé∞ Pure Game Logic Layer<a href="#-pure-game-logic-layer" class="hash-link" aria-label="Direct link to üé∞ Pure Game Logic Layer" title="Direct link to üé∞ Pure Game Logic Layer">‚Äã</a></h4><p>&quot;Pure&quot; game logic encompasses the &quot;domain&quot; of your game. Components in the pure game logic layer are typically repositories, which are usually just plain-old C# classes. Repositories are responsible for implementing the rules that compromise your game&#x27;s domain.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="the-domain-of-chess">The Domain of Chess<a href="#the-domain-of-chess" class="hash-link" aria-label="Direct link to The Domain of Chess" title="Direct link to The Domain of Chess">‚Äã</a></h5><p>In chess, the rook can capture any piece in its path if doing so would not put the king in check. The rook must also stop at the location where the capture occurs. The concept of &quot;capturing&quot; is a rule specific to chess, and thereby exists within the &quot;domain&quot; of chess.</p><p>Because capturing involves more than just a single chess piece, it can&#x27;t be implemented cleanly in the visual game logic layer. Instead, the state machine for a rook might realize it&#x27;s being directed to capture a piece, and then call a repository method to attempt the capture. If the rook is allowed to capture the piece, the repository will perform the capture, firing an event that the newly captured piece would already be subscribed to. The captured piece will remove itself from the board, and the repository can return a success indicator to the rook&#x27;s state machine.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/chess-183449097e1234bf9763685956c76252.png"><img src="/assets/images/chess-183449097e1234bf9763685956c76252.png" alt="Capturing in Chess" style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">The rules for capturing pieces falls within the game&#x27;s domain.</figcaption></figure><h5 class="anchor anchorWithStickyNavbar_LWe7" id="making-repositories">Making Repositories<a href="#making-repositories" class="hash-link" aria-label="Direct link to Making Repositories" title="Direct link to Making Repositories">‚Äã</a></h5><p>In the game demo, we have an <code>AppRepository</code> that allows us to handle the game logic for the entire app. Since collecting coins affects more than just a single visual component and is responsible for how you win the game, we handle coin collection inside the <code>AppRepository</code>.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token comment" style="color:#6c6783">/// &lt;summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783">/// Pure application game logic repository ‚Äî¬†shared between view-specific logic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783">/// blocks.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token comment" style="color:#6c6783">/// &lt;/summary&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">class</span><span class="token plain"> </span><span class="token class-name">AppRepo</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token type-list class-name">IAppRepo</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token comment" style="color:#6c6783">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">StartCoinCollection</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name">ICoin</span><span class="token plain"> coin</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _coinsBeingCollected</span><span class="token operator" style="color:#e09142">++</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _numCoinsCollected</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">OnNext</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">_numCoinsCollected</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Value </span><span class="token operator" style="color:#e09142">+</span><span class="token plain"> </span><span class="token number" style="color:#e09142">1</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    CoinCollected</span><span class="token punctuation" style="color:#6c6783">?.</span><span class="token function" style="color:#9a86fd">Invoke</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnFinishCoinCollection</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name">ICoin</span><span class="token plain"> coin</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _coinsBeingCollected</span><span class="token operator" style="color:#e09142">--</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token keyword" style="color:#ffcc99">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      _coinsBeingCollected </span><span class="token operator" style="color:#e09142">==</span><span class="token plain"> </span><span class="token number" style="color:#e09142">0</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      _numCoinsCollected</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Value </span><span class="token operator" style="color:#e09142">&gt;=</span><span class="token plain"> _numCoinsAtStart</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Value</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token function" style="color:#9a86fd">OnGameEnded</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">GameOverReason</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">PlayerWon</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token comment" style="color:#6c6783">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We&#x27;ve omitted quite a lot for the sake of brevity, but you probably get the idea: whenever a coin detects a collision with the player, it sends an event to its state machine, which starts the coin collection animation and tells the <code>AppRepository</code> that a coin is being collected. When the animation finishes, it tells the <code>AppRepository</code> that it&#x27;s finished being collected.</p><p>The <code>AppRepository</code> tracks the number of coins that were collected and then fires an event to end the game. Other state machines on other visual components are subscribed to the game-over event, handling cleanup or transitioning to other screens, as needed.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="how-data-flows-in-a-game">How Data Flows in a Game<a href="#how-data-flows-in-a-game" class="hash-link" aria-label="Direct link to How Data Flows in a Game" title="Direct link to How Data Flows in a Game">‚Äã</a></h5><p>A good state machine, behavior tree, or other state implementation should be able to subscribe to events occurring in repositories, as well as receive events and/or query data from the visual component they belong to.</p><p>You can think of data flowing <em>down into the state</em> from the visual component that owns it, and <em>bubbling upward from game logic repositories</em> that need to broadcast events.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/separating_game_logic-d773fc638f7b0437dc5277667fcd1a41.png"><img src="/assets/images/separating_game_logic-d773fc638f7b0437dc5277667fcd1a41.png" alt="Separating game logic from visualization." style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">Data flows down from the visuals via strongly coupled relationships, and bubbles back upwards via reactive mechanisms that promote loose coupling, like C# events, Observers, or other such utilities.</figcaption></figure><p>If all of this sounds familiar, it&#x27;s probably because it&#x27;s a <a href="https://reactivex.io/" target="_blank" rel="noopener noreferrer">reactive</a> (as in ReactiveX, or rx) style of coding. Or maybe you&#x27;ve used an <a href="https://dzone.com/articles/design-patterns-event-bus" target="_blank" rel="noopener noreferrer">event bus</a> ‚Äî another type of loosely-coupled, observable system.</p><blockquote><p>I tend to think of reactive-style code like glue: it&#x27;s extremely powerful, messy, and gets everywhere ‚Äî so use sparingly! If you&#x27;ve ever tried to explain multiple chained event source transformers that zip elements together to a junior programmer, you know just how tricky it is to wrap your head around. It&#x27;s also tricky for yourself, 6 months in the future.</p></blockquote><p>For the sake of convenience, I use a little reactive utility called <a href="https://github.com/chickensoft-games/Collections#autoprop" target="_blank" rel="noopener noreferrer"><code>AutoProp</code></a> inspired by C#&#x27;s built-in events and observers. It&#x27;s more or less the same API as a C# observer, but with a few tweaks to be more ergonomic.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name">IAutoProp</span><span class="token return-type class-name punctuation" style="color:#6c6783">&lt;</span><span class="token return-type class-name keyword" style="color:#ffcc99">bool</span><span class="token return-type class-name punctuation" style="color:#6c6783">&gt;</span><span class="token plain"> MyValue </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> _myValue</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token comment" style="color:#6c6783">// expose read-only version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">private</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">readonly</span><span class="token plain"> </span><span class="token class-name">AutoProp</span><span class="token class-name punctuation" style="color:#6c6783">&lt;</span><span class="token class-name keyword" style="color:#ffcc99">bool</span><span class="token class-name punctuation" style="color:#6c6783">&gt;</span><span class="token plain"> _myValue </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">AutoProp</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&lt;</span><span class="token constructor-invocation class-name keyword" style="color:#ffcc99">bool</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token boolean" style="color:#ffcc99">false</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To keep things sane, we can create feature-specific game repositories. These repositories can be provided to any game component&#x27;s state mechanism, allowing it to subscribe to the events offered by that repository. Since the visual game logic layer exists directly above the pure game logic layer, only state mechanisms will be allowed to interact with and subscribe to repositories.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-data-layer">üíΩ Data Layer<a href="#-data-layer" class="hash-link" aria-label="Direct link to üíΩ Data Layer" title="Direct link to üíΩ Data Layer">‚Äã</a></h3><p>The data layer represents various data clients in your application, like your network client or file client. In many cases, the game engine itself can suffice.</p><p>Because the data layer is the lowest layer of the application, repositories in the domain layer (your pure game logic) usually invoke various methods on the data layer to send and receive what they need through various channels. Like state machines subscribing to repositories, repositories can themselves subscribe to incoming data from the data layers, invoking their own events when something relevant in the game occurs, allowing all the relevant state machines to receive updates, which in turn updates their visual components. It&#x27;s turtles all the way up.</p><p>I didn&#x27;t implement a game saving or loading in the game demo, so I don&#x27;t have an example to show just yet. The next Chickensoft package I&#x27;m working on will hopefully help reduce the workload of implementing versioned game save systems, so hang tight.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-dependency-injection">üíâ Dependency Injection<a href="#-dependency-injection" class="hash-link" aria-label="Direct link to üíâ Dependency Injection" title="Direct link to üíâ Dependency Injection">‚Äã</a></h2><p>Once you know about all the things you&#x27;ll need, you have to figure out how to get it. We know our app is going to consist of visual components, state management mechanisms, repositories, and data clients.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/tree_based_dependencies-7250bda99e3525c675bcd4e26f9331af.png"><img src="/assets/images/tree_based_dependencies-7250bda99e3525c675bcd4e26f9331af.png" alt="Tree-based dependency provisioning" style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">Since Godot is a tree-based system, we can make nodes provide values to their descendant nodes.</figcaption></figure><p>In the real world, references to objects will trickle downward through each layer of abstraction until they settle into the right place. We&#x27;re following the &quot;objects in one layer shouldn&#x27;t know about any other objects except those in the layer directly below them&quot; rule from layered architecture, but once again, the real world isn&#x27;t quite so squeaky clean.</p><p>In reality, here&#x27;s how it actually works.</p><p>A Godot node script can provide a value to its descendants. In our game demo, the <code>Player</code> node script provides its logic block, <code>PlayerLogic</code>, to its descendant nodes, allowing them to bind to its state machine.</p><p>To get this value for the first time, though, each descendant will need to search their ancestors to see if any of them provide the type of value they&#x27;re looking for.</p><blockquote><p>In all but the deepest trees, doing an ancestor walk is a very quick way to resolve a dependency provider. Deeper trees can re-provide the value to lower sections, reducing search distances.</p></blockquote><p>There&#x27;s another problem, though. In Godot, the deepest nodes are &quot;readied&quot; up before their ancestors. This means that the dependent nodes are asking their ancestor provider nodes for values that the providers haven&#x27;t necessarily had a chance to initialize.</p><p>We solve this problem using <a href="https://github.com/chickensoft-games/AutoInject" target="_blank" rel="noopener noreferrer">AutoInject</a>, which itself leverages the <a href="https://github.com/chickensoft-games/Introspection" target="_blank" rel="noopener noreferrer">Introspection</a> source generator. Under the hood, AutoInject temporarily subscribes to providers for the values it needs. Once the providers have indicated all their dependencies are good to go, AutoInject will make sure the dependent nodes have a chance to set themselves up. If providers immediately provide their values as soon as they&#x27;re ready (and they should), all of this can happen in the same frame, making everything nice and deterministic.</p><p>To provide a value using AutoInject, our Player node simply needs to implement <code>IProvide&lt;T&gt;</code> for all of the value types it wants to provide.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">[</span><span class="token attribute class-name">Meta</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments keyword" style="color:#ffcc99">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments type-expression class-name">IAutoNode</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">partial</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">class</span><span class="token plain"> </span><span class="token class-name">Player</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token type-list class-name">CharacterBody3D</span><span class="token type-list punctuation" style="color:#6c6783">,</span><span class="token type-list"> </span><span class="token type-list class-name">IPlayer</span><span class="token type-list punctuation" style="color:#6c6783">,</span><span class="token type-list"> </span><span class="token type-list class-name">IProvide</span><span class="token type-list class-name punctuation" style="color:#6c6783">&lt;</span><span class="token type-list class-name">IPlayerLogic</span><span class="token type-list class-name punctuation" style="color:#6c6783">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">override</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">_Notification</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name keyword" style="color:#ffcc99">int</span><span class="token plain"> what</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">this</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Notify</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">what</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">region</span><span class="token preprocessor property" style="color:#9a86fd"> Provisions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token return-type class-name">IPlayerLogic</span><span class="token plain"> IProvide</span><span class="token operator" style="color:#e09142">&lt;</span><span class="token plain">IPlayerLogic</span><span class="token operator" style="color:#e09142">&gt;</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Value</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> PlayerLogic</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">endregion</span><span class="token preprocessor property" style="color:#9a86fd"> Provisions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token comment" style="color:#6c6783">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnReady</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    PlayerLogic </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">PlayerLogic</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token comment" style="color:#6c6783">/* ... */</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token function" style="color:#9a86fd">Provide</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token comment" style="color:#6c6783">// Indicate the dependencies we provide are now available.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A descendant can just as easily access a dependency from an ancestor node by using the <code>[Dependency]</code> attribute on a property.</p><p>The <code>PlayerModel</code> node, which is a descendant of the <code>Player</code> node, binds to the player state machine and triggers visual animations based on the state machine&#x27;s outputs.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">[</span><span class="token attribute class-name">Meta</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments keyword" style="color:#ffcc99">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments type-expression class-name">IAutoNode</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">partial</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">class</span><span class="token plain"> </span><span class="token class-name">PlayerModel</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token type-list class-name">Node3D</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">override</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">_Notification</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name keyword" style="color:#ffcc99">int</span><span class="token plain"> what</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">this</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Notify</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">what</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">region</span><span class="token preprocessor property" style="color:#9a86fd"> Dependencies</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain">Dependency</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name">IPlayerLogic</span><span class="token plain"> PlayerLogic </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token generic-method function" style="color:#9a86fd">DependOn</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">IPlayerLogic</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">endregion</span><span class="token preprocessor property" style="color:#9a86fd"> Dependencies</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnResolved</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    PlayerBinding </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> PlayerLogic</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Bind</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    PlayerBinding</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">.</span><span class="token generic-method function" style="color:#9a86fd">Handle</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">PlayerLogic</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Output</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Animations</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Idle</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> AnimationStateMachine</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Travel</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token string" style="color:#ffcc99">&quot;idle&quot;</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">.</span><span class="token generic-method function" style="color:#9a86fd">Handle</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">PlayerLogic</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Output</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Animations</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Move</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> AnimationStateMachine</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Travel</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token string" style="color:#ffcc99">&quot;move&quot;</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">.</span><span class="token generic-method function" style="color:#9a86fd">Handle</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">PlayerLogic</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Output</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Animations</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Jump</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> AnimationStateMachine</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Travel</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token string" style="color:#ffcc99">&quot;jump&quot;</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">.</span><span class="token generic-method function" style="color:#9a86fd">Handle</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">PlayerLogic</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Output</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Animations</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Fall</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> AnimationStateMachine</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Travel</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token string" style="color:#ffcc99">&quot;fall&quot;</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">.</span><span class="token generic-method function" style="color:#9a86fd">Handle</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">PlayerLogic</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Output</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">MoveSpeedChanged</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> AnimationTree</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Set</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">          </span><span class="token string" style="color:#ffcc99">&quot;parameters/main_animations/move/blend_position&quot;</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Speed</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token comment" style="color:#6c6783">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-simplified-dependencies">üò∂‚Äçüå´Ô∏è Simplified Dependencies<a href="#Ô∏è-simplified-dependencies" class="hash-link" aria-label="Direct link to üò∂‚Äçüå´Ô∏è Simplified Dependencies" title="Direct link to üò∂‚Äçüå´Ô∏è Simplified Dependencies">‚Äã</a></h3><p>Using such a simple dependency system provides a number of advantages.</p><ul><li>Simple to reason about.</li><li>Follows Godot&#x27;s natural tree-based structure.</li><li>Avoids nullability issues. Objects only exist when needed, where needed. Either the object and its dependents exist, or none of them exist. No more checking from your dependents to see if the thing you need is null or has null values.</li><li>Declarative style of coding, making it clear what&#x27;s responsible for what.</li></ul><p>Behind the scenes, AutoInject takes care of looking up providers, caching, subscribing to providers while it waits for them to provide values, and invalidating the cache when re-entering the tree. All we have to do is say what we&#x27;re providing or what we want, and make sure our descendants are placed beneath ancestors that give them the values they need.</p><p>In the game demo, you can just search for <code>[Dependency]</code> to see every value that&#x27;s looked up from an ancestor node. The visual nodes in the demo make extensive use of AutoInject to lookup repositories. Once dependencies are resolved, the repositories are passed to the state machines for the nodes.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-testing">üßë‚Äçüî¨ Testing<a href="#-testing" class="hash-link" aria-label="Direct link to üßë‚Äçüî¨ Testing" title="Direct link to üßë‚Äçüî¨ Testing">‚Äã</a></h2><p>If a software architecture allows all of the application&#x27;s individual &quot;units&quot; ‚Äî i.e., network clients, repositories, states, and views ‚Äî to be tested independently of each other, it&#x27;s probably a decent architecture. After all, testing something in isolation is the definition of a &quot;unit test&quot;.</p><p>In unit testing, a &quot;unit&quot; is the smallest possible unit of code that can be tested in isolation. This annoying, recursive definition is important, because the quality of the architecture can determine how big a unit is. In an ideal world, each unit would belong in one ‚Äî and only one ‚Äî layer of abstraction.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/not_so_layered_architecture-4368ee6fffc9045d2141c5c9f820e6b9.png"><img src="/assets/images/not_so_layered_architecture-4368ee6fffc9045d2141c5c9f820e6b9.png" alt="Not-so-layered architecture" style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">We&#x27;ve all been there.</figcaption></figure><p>Historically, unit-testing visual components in game engines has been nearly impossible. Even Unity admits that a <code>MonoBehavior</code> <a href="https://blog.unity.com/technology/unit-testing-part-2-unit-testing-monobehaviours" target="_blank" rel="noopener noreferrer">can&#x27;t really be unit-tested</a>.</p><p>In Godot, things are a little better. You can easily spin up a new instance of a scene, add it to a test scene, and use <a href="https://github.com/chickensoft-games/GoDotTest" target="_blank" rel="noopener noreferrer">GoDotTest</a> with <a href="https://github.com/derkork/godot-test-driver" target="_blank" rel="noopener noreferrer">GodotTestDriver</a> to call the scene script&#x27;s methods and assert that it manipulates the engine environment as you expect, and then undo anything it changes.</p><p>Most people stop at this point, perfectly happy to be able to write tests for most things in their game. And that&#x27;s fine, especially if you don&#x27;t want to measure code coverage.</p><p>If you cannot quench your thirst for testing, and you find yourself wanting to measure code coverage accurately, the approach mentioned above won&#x27;t quite work. You&#x27;ll quickly realize that spinning up a scene means any of its child scenes get spun up, too. And if those child scenes have scripts, those get executed. That brings in a ton of other systems that you need to mock or swap in fake objects for, but there&#x27;s no way to intercept the deserialization of the scene and swap everything out.</p><p>By now, your simple &quot;unit&quot; test has gone supernova, and is crossing so many layers of abstraction that your test has exploded into an integration test. As a result, your test ends up testing everything else in your game, and your code coverage becomes meaningless.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/scene_explosion-021278970cf535231554b8004238174a.png"><img src="/assets/images/scene_explosion-021278970cf535231554b8004238174a.png" alt="The scene explosion problem." style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">Testing a scene in isolation is very hard to do, since they directly deserialize child scenes and their scripts.</figcaption></figure><p>After all, code coverage is only accurate if you test each system in perfect isolation. Otherwise, you&#x27;re contaminating the results and you won&#x27;t be able to easily tell which systems you haven&#x27;t tested yet.</p><p>I can hear you wondering &quot;well, what&#x27;s the point of unit testing, then? Is it even worth it to test such small &#x27;units&#x27; of functionality?&quot;</p><p>Yes, but not because we want to verify behavior. That&#x27;s just an added bonus.</p><p>Wait, what? The point of unit testing isn&#x27;t to verify behavior? Correct ‚Äî at least, in my opinion.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-why-write-unit-tests-at-all">üß™ Why Write Unit Tests At All?<a href="#-why-write-unit-tests-at-all" class="hash-link" aria-label="Direct link to üß™ Why Write Unit Tests At All?" title="Direct link to üß™ Why Write Unit Tests At All?">‚Äã</a></h3><p>I feel the same about unit tests as I do about high school teachers insisting we &quot;show our work&quot; in algebra class. It&#x27;s a total chore, but it builds expertise and it&#x27;s the right thing to do, even if you can just &quot;solve it all in your head&quot; (you never can when it comes to code).</p><p>Chores are just that. Necessary. We have to keep our houses clean or we end up with a bug infestation. Likewise, we have to keep our code clean or we end up with ‚Äî wait. You get the idea.</p><p>If you, like me, dread cleaning your house, you should recall the age-old rule: if you have to do something you don&#x27;t like, make it as easy as possible to do. Set yourself up for success. Listen to your favorite music while you clean the house and promise yourself you&#x27;ll go out to dinner after.</p><p>So here&#x27;s why I actually think unit tests are important:</p><ul><li><strong>Unit tests are &quot;showing your work.&quot;</strong> They ensure every line of code is executed at least once.</li><li><strong>Unit tests enforce consistency and ensure your architecture is followed.</strong> If you&#x27;re not following the same architecture, it becomes harder to write tests. - Let&#x27;s be honest: most tests start out as a copy/paste of some other tests, so you want to get this right up front.</li><li><strong>Unit tests are disposable.</strong> If you refactor something heavily, it&#x27;s probably easier to just delete the tests and start over than it is to refactor the tests. Plus, you&#x27;ll end up with better tests and it&#x27;s often faster, anyways. If you&#x27;re writing code decently well, this will be a non-issue.</li><li><strong>Unit tests act as living documentation.</strong> Your project wouldn&#x27;t compile if they weren&#x27;t up-to-date. If a developer needs to know how to use a particular piece of code, they can quickly look at the tests and get everything they need, because all of that code&#x27;s capabilities will have tests.</li><li><strong>Unit tests verify the state and/or behavior of the test subject.</strong></li></ul><p>The fact that unit tests verify your code does what you say it does is just the icing on top. If code is strongly coupled, it becomes almost impossible to unit test. The mere existence of unit tests proves the code isn&#x27;t terrible.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/unit_tests-31d71e2c67517d684e0821fe3260f8df.png"><img src="/assets/images/unit_tests-31d71e2c67517d684e0821fe3260f8df.png" alt="Why that one teammate won&#x27;t shut up about unit tests" style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">Now you can be that annoying teammate that won&#x27;t shut up about unit tests!</figcaption></figure><p><strong>If unit tests feel repetitive, it&#x27;s because they are.</strong> Depending on the test subject, you might end up testing a bit of behavior and state, which means that some of the tests can end up pretty tightly coupled. Obviously, with some practice or test utility abstractions, you can make them less coupled, but there tend to be plenty of tests that are basically just verifying the implementation of the test subject. And that&#x27;s fine, because they&#x27;re disposable. With today&#x27;s AI-assisted coding, you&#x27;ll be fine ‚Äî I promise.</p><blockquote><p>If you&#x27;re just making a prototype of a game to get the gameplay right, you&#x27;re not going to want to write many unit tests, if any. Unit testing tends to lock-in a lot of code, so don&#x27;t do it until you&#x27;re making the actual game.</p></blockquote><p>An optimal architecture allows a game to achieve 100% code coverage through unit tests. There will always be situations where performance-critical code might be so tightly coupled that testing it in isolation is too difficult and a unit crosses more than one layer of abstraction. Fortunately, if everything else in your codebase is modularized enough to be tested in isolation, carving out a little blast radius where the rules are broken is perfectly allowable. It&#x27;s one of those ‚Äúyou have to know the rules to break the rules‚Äù type of things.</p><p>Assuming you&#x27;re convinced, let&#x27;s talk about how it&#x27;s actually done, now.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-unit-tests-in-practice">üî¨ Unit Tests In Practice<a href="#-unit-tests-in-practice" class="hash-link" aria-label="Direct link to üî¨ Unit Tests In Practice" title="Direct link to üî¨ Unit Tests In Practice">‚Äã</a></h3><p>To be able to test Godot scenes that incorporate other scenes, we need to be able make an instance of a scene without deserializing the actual scene file. Fortunately, Godot allows us to just <code>new</code> up any scene script we want ‚Äî problem solved. Except, not quite. Once we add the script to the test scene to begin testing it, it will crash if it tries to find any children, since it won&#x27;t have any. The child instances come from the <code>.tscn</code> file that we&#x27;d normally deserialize when loading a scene, but since we just created an instance of a script, there won&#x27;t be any children.</p><p>That&#x27;s fine. We can just add a little functionality to our script (using a mixin) that simulates a fake node tree and returns fake nodes based on the paths it expects. This works surprisingly well, except we can&#x27;t return interfaces, making mocking impossible. The reason we can&#x27;t return interfaces is because Godot nodes don&#x27;t actually have any corresponding interfaces ‚Äî they&#x27;re just classes.</p><p>Since there‚Äôs no interfaces, we have to create an actual node for every child. And that gets really tedious really fast, resulting in a ton of test fixtures.</p><p>So, to get around this, I‚Äôve created <a href="https://github.com/chickensoft-games/GodotNodeInterfaces" target="_blank" rel="noopener noreferrer">GodotNodeInterfaces</a>, which generates interfaces and adapters for every type of Godot node. It also provides alternative methods for accessing child nodes as their adapted interface, and works with a fake scene tree system for testing.</p><figure style="margin:0px 0px var(--ifm-leading);text-align:center"><a href="/assets/images/testing_abstractions-888f71e1739a5903bc8f5bb81a0f2b08.png"><img src="/assets/images/testing_abstractions-888f71e1739a5903bc8f5bb81a0f2b08.png" alt="Layers of Abstraction in Testing" style="width:100%"></a><figcaption style="font-size:0.8rem;font-style:italic;text-align:center">Some things just can&#x27;t be automated.</figcaption></figure><p>I haven&#x27;t done extensive profiling with GodotNodeInterfaces, since I was getting hundreds of frames per second while using it. I imagine there‚Äôs a slight performance impact in cases where the compiler can‚Äôt inline everything.</p><p>Because the alternative child access functions GodotNodeInterfaces provides return wrapped versions of real Godot nodes, there‚Äôs an allocation overhead. Fortunately, the allocation overhead can be mitigated by storing node references at the time your node script is created, getting all the allocations out of the way at once.</p><p>If you‚Äôre still worried about performance, though, take it from one of my personal heroes, <a href="https://twitter.com/munificentbob" target="_blank" rel="noopener noreferrer">Bob</a>:</p><blockquote><p>My experience, though, is that it‚Äôs easier to make a fun game fast than it is to make a fast game fun. One compromise is to keep the code flexible until the design settles down and then tear out some of the abstraction later to improve your performance. ‚Äî <a href="https://gameprogrammingpatterns.com/architecture-performance-and-games.html" target="_blank" rel="noopener noreferrer">Architecture, Performance, and Games</a></p></blockquote><p>See? There‚Äôs always plenty of time to write bad code! Once your game becomes sickeningly clean, stable, and fun to play, you have my blessing to corrupt it for the sake of performance. After all, ‚Äúall magic comes at a price,‚Äù or something like that.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-testing-tips">üíÅ Testing Tips<a href="#-testing-tips" class="hash-link" aria-label="Direct link to üíÅ Testing Tips" title="Direct link to üíÅ Testing Tips">‚Äã</a></h3><p>If you haven&#x27;t done much testing with C#, you&#x27;ll probably want to familiarize yourself with the basics, <a href="https://www.codemag.com/Article/2305041/Using-Moq-A-Simple-Guide-to-Mocking-for-.NET" target="_blank" rel="noopener noreferrer">including mocking</a>.</p><p>In this last section, we&#x27;ll demonstrate how the architecture we&#x27;ve outlined above allows us to test everything relatively easily.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-understanding-visual-testing">üé® Understanding Visual Testing<a href="#-understanding-visual-testing" class="hash-link" aria-label="Direct link to üé® Understanding Visual Testing" title="Direct link to üé® Understanding Visual Testing">‚Äã</a></h4><p>To test visual components, we have to reason very carefully about them. As mentioned previously, there&#x27;s two ways to instantiate a Godot node for testing.</p><ol><li><p>Instantiate the visual component&#x27;s scene script directly. We avoid doing this in unit tests since it would pollute code coverage by executing more than one unit in a unit-test. For integration tests or when we&#x27;re not measuring code coverage, instantiating scenes directly works easily enough.</p></li><li><p>Create a new instance of a scene script, without deserializing its scene. This breaks child relationships once added to a scene tree, since those children don&#x27;t exist since we didn&#x27;t deserialize a scene file. We can get around this by using a fake scene tree system, which is what GodotNodeInterfaces provides.</p></li></ol><p>We will always use approach <code>#2</code>.</p><p>Once we have an instance of a node to test, there&#x27;s two ways to test it.</p><ol><li><p>We can add the node to the test scene tree, which allows it to manipulate the game engine environment and take up space in the world. For many nodes, we <strong>have</strong> to actually add them to the scene tree during testing to be able to verify their interactions with the engine.</p></li><li><p>Alternatively, we can just call methods on the node without adding them to the scene tree. This works if nothing in the methods manipulates the scene tree or other properties of the node that require it to be in the tree. For many nodes, we can get away with this approach, since it&#x27;s a bit simpler.</p></li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-setting-up-testing">üë∑ Setting Up Testing<a href="#-setting-up-testing" class="hash-link" aria-label="Direct link to üë∑ Setting Up Testing" title="Direct link to üë∑ Setting Up Testing">‚Äã</a></h4><p>We&#x27;ll be using <a href="https://github.com/chickensoft-games/GoDotTest" target="_blank" rel="noopener noreferrer">GoDotTest</a> as our test runner. GoDotTest guarantees a few invariants for us that help us run tests deterministically.</p><ul><li>Tests are always executed one at a time, in the order they appear in the code for a particular test class.</li><li><code>Setup</code> and <code>Cleanup</code> methods can be called before and after each test, and <code>SetupAll</code> and <code>CleanupAll</code> methods can be called before and after running a test suite (i.e., a test class).</li><li>Tests are able to be placed on the test scene.</li><li>Tests can be run from the command-line, for CI/CD purposes.</li><li>Tests are never run in parallel.</li><li>Tests and their setup methods can be asynchronous, or not.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-two-phase-initialization">üß¨ Two-Phase Initialization<a href="#-two-phase-initialization" class="hash-link" aria-label="Direct link to üß¨ Two-Phase Initialization" title="Direct link to üß¨ Two-Phase Initialization">‚Äã</a></h4><p>We frequently need to <strong>separate our script&#x27;s initialization into two phases</strong>: one phase for <strong>creating the values</strong> that belong to that script, such as its dependencies, state machines, and bindings, and the second for <strong>using those dependencies or bindings</strong>. If we don&#x27;t separate the initialization from the usage, we won&#x27;t have a way to inject mock values during a unit test since the values would be created and immediately used afterwards.</p><p>In practice, here&#x27;s what splitting our initialization into two-phases looks like.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token punctuation" style="color:#6c6783">[</span><span class="token attribute class-name">Meta</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments keyword" style="color:#ffcc99">typeof</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">(</span><span class="token attribute attribute-arguments type-expression class-name">IAutoNode</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token attribute attribute-arguments punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain"></span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">partial</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">class</span><span class="token plain"> </span><span class="token class-name">InGameUI</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">:</span><span class="token plain"> </span><span class="token type-list class-name">Control</span><span class="token type-list punctuation" style="color:#6c6783">,</span><span class="token type-list"> </span><span class="token type-list class-name">IInGameUI</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">override</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">_Notification</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token class-name keyword" style="color:#ffcc99">int</span><span class="token plain"> what</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">this</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Notify</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">what</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">region</span><span class="token preprocessor property" style="color:#9a86fd"> Dependencies</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain">Dependency</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name">IAppRepo</span><span class="token plain"> AppRepo </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token generic-method function" style="color:#9a86fd">DependOn</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">IAppRepo</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">endregion</span><span class="token preprocessor property" style="color:#9a86fd"> Dependencies</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">region</span><span class="token preprocessor property" style="color:#9a86fd"> Nodes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token plain">Node</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name">ILabel</span><span class="token plain"> CoinsLabel </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">get</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">set</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">default</span><span class="token operator" style="color:#e09142">!</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">endregion</span><span class="token preprocessor property" style="color:#9a86fd"> Nodes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">region</span><span class="token preprocessor property" style="color:#9a86fd"> State</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name">IInGameUILogic</span><span class="token plain"> InGameUILogic </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">get</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">set</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">default</span><span class="token operator" style="color:#e09142">!</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name">InGameUILogic</span><span class="token return-type class-name punctuation" style="color:#6c6783">.</span><span class="token return-type class-name">IBinding</span><span class="token plain"> InGameUIBinding </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">get</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">set</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">default</span><span class="token operator" style="color:#e09142">!</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token preprocessor property" style="color:#9a86fd">#</span><span class="token preprocessor property directive keyword" style="color:#ffcc99">endregion</span><span class="token preprocessor property" style="color:#9a86fd"> State</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">Setup</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    InGameUILogic </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">InGameUILogic</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token keyword" style="color:#ffcc99">this</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> AppRepo</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">OnResolved</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    InGameUIBinding </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> InGameUILogic</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Bind</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    InGameUIBinding</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">.</span><span class="token generic-method function" style="color:#9a86fd">Handle</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&lt;</span><span class="token generic-method generic class-name">InGameUILogic</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">Output</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">.</span><span class="token generic-method generic class-name">NumCoinsChanged</span><span class="token generic-method generic class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">SetCoinsLabel</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">          output</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsCollected</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">NumCoinsAtStart</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    InGameUILogic</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Start</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once again, we&#x27;re looking at the <code>InGameUI</code> view that displays the number of coins the user has collected while in-game. Notice the separate methods, <code>Setup()</code> and <code>OnResolved()</code>. The first method creates the <code>InGameUILogic</code> state machine, while the second binds to the state machine&#x27;s outputs and starts the state machine.</p><p>Since the script above uses <a href="https://github.com/chickensoft-games/AutoInject" target="_blank" rel="noopener noreferrer">AutoInject</a> to resolve dependencies, we can leverage a lesser-known feature of AutoInject to help with this initialization process. AutoInject normally calls the <code>OnResolved()</code> method on your script once all the providers it found for your script&#x27;s dependencies indicate they&#x27;ve provided their values, but there&#x27;s more to it than that.</p><p>If you have a <code>Setup()</code> method on your script, that method will be called after dependencies are resolved, but right before <code>OnResolved()</code> is called ‚Äî if, and only if ‚Äî your script&#x27;s <code>IsTesting</code> property is set to false. The <code>IsTesting</code> property isn&#x27;t shown, though ‚Äî it&#x27;s tucked away in a generated file.</p><p>By utilizing two-phase initialization, we are able to test our game component easily within the scene tree.</p><p>I won&#x27;t show full tests here, but you can check out the tests for the <a href="https://github.com/chickensoft-games/GameDemo/blob/main/test/src/player/PlayerTest.cs" target="_blank" rel="noopener noreferrer">Player</a> node. It takes advantage of the two-phase initialization by preventing the Player&#x27;s <code>Setup()</code> method from ever being invoked when running in the actual test scene, ensuring our mocked values get injected instead.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-faking-the-scene-tree">üå≤ Faking the Scene Tree<a href="#-faking-the-scene-tree" class="hash-link" aria-label="Direct link to üå≤ Faking the Scene Tree" title="Direct link to üå≤ Faking the Scene Tree">‚Äã</a></h4><p>Each scene should have only one script on its root node.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>If you find yourself needing to add a script to a non-root node in a Godot scene, don‚Äôt. Instead, save the node branch as its own scene before adding a script to it.</p><p>Likewise, if you you find yourself writing a Godot node script that manipulates its grandchildren, you may run into difficulty testing the script as a unit-test with a fake node tree. For best results, add a script to the child and ask it to manipulate its own children from your script. The general rule of thumb is &quot;no script should manipulate nodes deeper than its children.&quot;</p></div></div><p>Ensuring each scene only has one script on its root node allows you to make use of the fake scene tree system provided by <a href="https://github.com/chickensoft-games/GodotNodeInterfaces" target="_blank" rel="noopener noreferrer">GodotNodeInterfaces</a> to easily test your scene. By referencing nodes as interfaces and automatically hooking them up with the <a href="https://github.com/chickensoft-games/AutoInject" target="_blank" rel="noopener noreferrer"><code>IAutoConnect</code></a> mixin, we can easily test our scene in isolation without spinning up the entire subtree.</p><p>In the example below, taken from the game demo&#x27;s <a href="https://github.com/chickensoft-games/GameDemo/blob/main/test/src/coin/CoinTest.cs#L47-L50" target="_blank" rel="noopener noreferrer">unit tests for the spinning gold coins</a>, we setup our tests by creating mock versions of the values the coin needs and then call the <code>FakeNodeTree</code> to instruct our coin to use the mock objects for nodes at the provided paths instead of trying to connect to real children nodes.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token attribute class-name">Setup</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token keyword" style="color:#ffcc99">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#ffcc99">void</span><span class="token plain"> </span><span class="token function" style="color:#9a86fd">Setup</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _appRepo </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Mock</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&lt;</span><span class="token constructor-invocation class-name">IAppRepo</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _animPlayer </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Mock</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&lt;</span><span class="token constructor-invocation class-name">IAnimationPlayer</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _coinModel </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Mock</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&lt;</span><span class="token constructor-invocation class-name">INode3D</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _logic </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Mock</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&lt;</span><span class="token constructor-invocation class-name">ICoinLogic</span><span class="token constructor-invocation class-name punctuation" style="color:#6c6783">&gt;</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _binding </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> CoinLogic</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">CreateFakeBinding</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _logic</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Setup</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">logic </span><span class="token operator" style="color:#e09142">=&gt;</span><span class="token plain"> logic</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Bind</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">Returns</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">_binding</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _coin </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ffcc99">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Coin</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      IsTesting </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> </span><span class="token boolean" style="color:#ffcc99">true</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      AnimationPlayer </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> _animPlayer</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      CoinModel </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> _coinModel</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      CoinLogic </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> _logic</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      CoinBinding </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> _binding</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _coin</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">FakeDependency</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token plain">_appRepo</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    _coin</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token function" style="color:#9a86fd">FakeNodeTree</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token keyword" style="color:#ffcc99">new</span><span class="token punctuation" style="color:#6c6783">(</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#6c6783">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token string" style="color:#ffcc99">&quot;%AnimationPlayer&quot;</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> _animPlayer</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:#6c6783">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">      </span><span class="token punctuation" style="color:#6c6783">[</span><span class="token string" style="color:#ffcc99">&quot;%CoinModel&quot;</span><span class="token punctuation" style="color:#6c6783">]</span><span class="token plain"> </span><span class="token operator" style="color:#e09142">=</span><span class="token plain"> _coinModel</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">Object</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    </span><span class="token punctuation" style="color:#6c6783">}</span><span class="token punctuation" style="color:#6c6783">)</span><span class="token punctuation" style="color:#6c6783">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">  </span><span class="token punctuation" style="color:#6c6783">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-mocking-dependencies-provided-with-autoinject">ü•∏ Mocking Dependencies Provided with AutoInject<a href="#-mocking-dependencies-provided-with-autoinject" class="hash-link" aria-label="Direct link to ü•∏ Mocking Dependencies Provided with AutoInject" title="Direct link to ü•∏ Mocking Dependencies Provided with AutoInject">‚Äã</a></h4><p>In the example above, we also used the <code>FakeDependency</code> method generated with AutoInject. Faking a dependency prevents the dependent node from searching the tree for providers ‚Äî¬†which wouldn&#x27;t be present in a test scenario where you&#x27;re just testing a script by itself. Instead, the dependent node we&#x27;re testing will just use the provided value when it looks up a dependency of that type, allowing us to easily mock dependencies.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-file-structure-and-feature-based-architecture">üóÇ File Structure and Feature-Based Architecture<a href="#-file-structure-and-feature-based-architecture" class="hash-link" aria-label="Direct link to üóÇ File Structure and Feature-Based Architecture" title="Direct link to üóÇ File Structure and Feature-Based Architecture">‚Äã</a></h2><p>Files should be organized in a way that benefits the artists and developers contributing to the codebase. Allow me to suggest feature-based organization here.</p><p>In feature-based organization, files are organized by feature, with any files that get shared between features in some sort of shared directory, typically called something like <code>common</code>.</p><p>In the game demo, we define features pretty simply. The player runs around collecting coins, jumping on mushrooms, and interacting with a physical environment. So, a mushroom is a feature, so is a coin, etc. You can define features however you want, but you probably want to check out the section &quot;Thinking in Tokens&quot; in Chapter 17 (page 482) of <em>Game Architecture and Design: A New Edition</em> by Rollings and Morris.</p><p>In feature-based architecture, you really want to avoid strongly coupling your features together. If you can keep them loosely coupled, you can add and remove them with ease.</p><p>Take a look at how the files are implemented for the Coin feature:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îú‚îÄ‚îÄ src</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îú‚îÄ‚îÄ coin</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Coin.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ Coin.tscn</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CollectorDetector.tscn</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ audio</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ coin_collected.mp3</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ coin_collected.mp3.import</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ state</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CoinLogic.Input.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CoinLogic.Output.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CoinLogic.State.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CoinLogic.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CoinLogic.g.puml</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ states</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ CoinLogic.State.Collecting.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ CoinLogic.State.Idle.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ visuals</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ coin_model.glb</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ coin_model.glb.import</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ coin_normal.tres</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ coin_roughness.tres</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ coin_texture.tres</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ teleport_3d.gdshader</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Everything the coin needs is located inside the <code>coin</code> folder. Even the states for the state machine are located in the <code>state/states</code> subfolder. All the other features are organized in the same way, too, making it easy for a developer to jump in and fix something, even if she hasn&#x27;t been working on that feature. Artists can also quickly intuit where they might need to drop some updated visuals, too.</p><p>I often see people suggest to keep separate folders for each type of file, like <code>scripts</code>, <code>scenes</code>, <code>textures</code>, etc. My little brain finds this organizational pattern difficult since related files are split across multiple places and it makes it harder to remember to go and rename the corresponding files in top-level directories elsewhere whenever you decide to rename something. You also have to know how to identify all the related files, too, which becomes a memory exercise in and of itself.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-preventing-strong-coupling-in-features">ü™¢ Preventing Strong Coupling in Features<a href="#-preventing-strong-coupling-in-features" class="hash-link" aria-label="Direct link to ü™¢ Preventing Strong Coupling in Features" title="Direct link to ü™¢ Preventing Strong Coupling in Features">‚Äã</a></h3><p>To keep my features from being strongly coupled to each other, I made them interact with each other via interfaces. For example, the coin can be collected by anything that implements <code>ICoinCollector</code>. The coin doesn&#x27;t care what it is, it just knows that it can be collected by anything that implements that interface. In the game, it&#x27;s just the player.</p><p>To facilitate this, I simply created a folder in my <code>src</code> directory that contained interfaces used across features. I could have put these in a common directory, but I decided to have a <code>traits</code> directory for this sort of thing.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îú‚îÄ‚îÄ src</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îú‚îÄ‚îÄ traits</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ ICoinCollector</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ IKillable</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ IPushEnabled</span><span class="token punctuation" style="color:#6c6783">.</span><span class="token plain">cs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>No doubt, you can find further organizational patterns that improve on this. When you do, please pop into our Discord and share them with me ^-^.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-file-structure-for-tests">üèõ File Structure for Tests<a href="#-file-structure-for-tests" class="hash-link" aria-label="Direct link to üèõ File Structure for Tests" title="Direct link to üèõ File Structure for Tests">‚Äã</a></h3><p>The unit tests for everything in the game demo are 1:1 mirror of everything in the source directory that needs tests, with the added <code>Test</code> suffix added to each file.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#2a2734;--prism-color:#9a86fd"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9a86fd"><span class="token plain">‚îî‚îÄ‚îÄ test</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">    ‚îî‚îÄ‚îÄ src</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        ‚îú‚îÄ‚îÄ coin</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ CoinTest.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ state</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ CoinLogicTest.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ states</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ CoinLogic.State.CollectingTest.cs</span><br></span><span class="token-line" style="color:#9a86fd"><span class="token plain">        ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ CoinLogic.State.IdleTest.cs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-conclusion">ü•∞ Conclusion<a href="#-conclusion" class="hash-link" aria-label="Direct link to ü•∞ Conclusion" title="Direct link to ü•∞ Conclusion">‚Äã</a></h2><p>Thank you for reading my (excessively long) article on game architecture. There&#x27;s no way I could dive into everything into as much detail as I wanted, so if you have questions, please feel free to reach out to me. If you find ways of working that are easier, better, and more enjoyable, please don&#x27;t keep them to yourself. I&#x27;d love to assimilate your knowledge!</p><section style="margin-bottom:var(--ifm-leading)"><div class="inviteContainer_H3cR"><div class="discordServer_Be5H"><h3 class="discordInviteText_xFKC">You have been invited to join a server</h3><div class="discordInviteBody_jtVf"><div><img src="/img/chickensoft/chickensoft_logo.svg" class="serverImage_snrK"></div><div class="discordInviteDetails_UNwE"><h3 class="discordInviteName_OuUx">Chickensoft</h3><div class="discordInviteCounts_wTwU"><i class="discordInviteStatusIcon_ySkV discordInviteOnlineIcon_e0ks"></i><strong class="discordInviteCount_qEVM"><span id="discordNumOnline">#</span> <!-- -->Online</strong><i class="discordInviteStatusIcon_ySkV discordInviteOfflineIcon_R82S"></i><strong class="discordInviteCount_qEVM"><span id="discordNumMembers">#</span> <!-- -->Members</strong></div></div></div><div class="discordButtonContainer_oTIm"><a class="button button--primary button--lg discordInviteJoinButton_VJ9M" href="https://discord.gg/MjA6HUzzAE">Join</a></div></div></div></section></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/godot-csharp-2024"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Using Godot with C# in 2024</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/godot-delivers"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Can Godot Deliver?</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#-what-is-software-architecture" class="table-of-contents__link toc-highlight">üí° What Is Software Architecture?</a></li><li><a href="#-abstraction-layers" class="table-of-contents__link toc-highlight">üç∞ Abstraction Layers</a><ul><li><a href="#-visual-layer" class="table-of-contents__link toc-highlight">üé≠ Visual Layer</a></li><li><a href="#-gamelogic-layer" class="table-of-contents__link toc-highlight">ü§ñ GameLogic Layer</a><ul><li><a href="#-visual-game-logic-layer" class="table-of-contents__link toc-highlight">üñº Visual Game Logic Layer</a></li><li><a href="#-pure-game-logic-layer" class="table-of-contents__link toc-highlight">üé∞ Pure Game Logic Layer</a></li></ul></li><li><a href="#-data-layer" class="table-of-contents__link toc-highlight">üíΩ Data Layer</a></li></ul></li><li><a href="#-dependency-injection" class="table-of-contents__link toc-highlight">üíâ Dependency Injection</a><ul><li><a href="#Ô∏è-simplified-dependencies" class="table-of-contents__link toc-highlight">üò∂‚Äçüå´Ô∏è Simplified Dependencies</a></li></ul></li><li><a href="#-testing" class="table-of-contents__link toc-highlight">üßë‚Äçüî¨ Testing</a><ul><li><a href="#-why-write-unit-tests-at-all" class="table-of-contents__link toc-highlight">üß™ Why Write Unit Tests At All?</a></li><li><a href="#-unit-tests-in-practice" class="table-of-contents__link toc-highlight">üî¨ Unit Tests In Practice</a></li><li><a href="#-testing-tips" class="table-of-contents__link toc-highlight">üíÅ Testing Tips</a><ul><li><a href="#-understanding-visual-testing" class="table-of-contents__link toc-highlight">üé® Understanding Visual Testing</a></li><li><a href="#-setting-up-testing" class="table-of-contents__link toc-highlight">üë∑ Setting Up Testing</a></li><li><a href="#-two-phase-initialization" class="table-of-contents__link toc-highlight">üß¨ Two-Phase Initialization</a></li><li><a href="#-faking-the-scene-tree" class="table-of-contents__link toc-highlight">üå≤ Faking the Scene Tree</a></li><li><a href="#-mocking-dependencies-provided-with-autoinject" class="table-of-contents__link toc-highlight">ü•∏ Mocking Dependencies Provided with AutoInject</a></li></ul></li></ul></li><li><a href="#-file-structure-and-feature-based-architecture" class="table-of-contents__link toc-highlight">üóÇ File Structure and Feature-Based Architecture</a><ul><li><a href="#-preventing-strong-coupling-in-features" class="table-of-contents__link toc-highlight">ü™¢ Preventing Strong Coupling in Features</a></li><li><a href="#-file-structure-for-tests" class="table-of-contents__link toc-highlight">üèõ File Structure for Tests</a></li></ul></li><li><a href="#-conclusion" class="table-of-contents__link toc-highlight">ü•∞ Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Help</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/philosophy">Chickensoft Development Philosophy</a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/license">Open Source License</a></li></ul></div><div class="col footer__col"><div class="footer__title">Organization</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/chickensoft-games" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forms.gle/CZLsupjR3GM4a85v9" target="_blank" rel="noopener noreferrer" class="footer__link-item">‚≠êÔ∏è Using Chickensoft packages? Let us know!<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.b9624ef8.js"></script>
<script src="/assets/js/main.b297899a.js"></script>
</body>
</html>